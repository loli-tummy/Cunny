package pictures.cunny.client.impl.modules.exploits;

import net.minecraft.network.protocol.game.*;
import net.minecraft.world.inventory.ClickType;
import pictures.cunny.client.framework.events.EventListener;
import pictures.cunny.client.framework.modules.Categories;
import pictures.cunny.client.framework.modules.Module;
import pictures.cunny.client.impl.events.game.PacketEvent;
import pictures.cunny.client.utility.InventoryUtils;
import pictures.cunny.client.utility.PacketUtils;

public class EndGodMode extends Module {
    private int lastTeleportId = -1;

    public EndGodMode() {
        super(Categories.EXPLOITS, "end-god-mode", "Allows you to disappear into an end portal");
    }

    @EventListener(inGame = false)
    public void onPacketReceived(PacketEvent.Received event) {
        if (event.packet instanceof ClientboundContainerSetSlotPacket packet) {
            InventoryUtils.clickSlot(packet.getSlot(), 1, ClickType.THROW);
        } else if (event.packet instanceof ClientboundPlayerPositionPacket packet) {
            lastTeleportId = packet.getId();
        } else if (event.packet instanceof ClientboundGameEventPacket packet) {
            if (packet.getEvent() == ClientboundGameEventPacket.WIN_GAME) {
                event.cancel();
            }
        }
    }

    @EventListener
    public void onPacketSend(PacketEvent.Send event) {
        if (event.packet instanceof ServerboundAcceptTeleportationPacket) {
            event.cancel();
        } else if (event.packet instanceof ServerboundClientCommandPacket packet) {
            if (packet.getAction() == ServerboundClientCommandPacket.Action.PERFORM_RESPAWN) {
                if (lastTeleportId != -1)
                    PacketUtils.send(new ServerboundAcceptTeleportationPacket(lastTeleportId));
                event.cancel();
            }
        }
    }
}
